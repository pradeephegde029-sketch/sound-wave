<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soundwave</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#08080f;--surface:#111119;--surface2:#18181f;--surface3:#22222d;--border:#2a2a38;--accent:#7c5cfc;--accent2:#fc5c7d;--accent3:#3ee8b5;--text:#f0f0f8;--text2:#9090b0;--text3:#55556a;--ph:86px;--r:10px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}
.app{display:grid;grid-template-columns:220px 1fr;grid-template-rows:1fr var(--ph);height:100vh}

/* SIDEBAR */
.sidebar{grid-row:1/2;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.logo{padding:22px 18px 18px;border-bottom:1px solid var(--border)}
.logo-mark{font-size:18px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-sub{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:2px;margin-top:2px}
.nav-scroll{flex:1;overflow-y:auto;padding:14px 10px}
.nav-section{margin-bottom:20px}
.nav-label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2.5px;color:var(--text3);padding:0 8px;margin-bottom:5px;text-transform:uppercase}
.nav-btn{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2);transition:all .12s;border:none;background:none;width:100%;text-align:left}
.nav-btn:hover{background:var(--surface2);color:var(--text)}
.nav-btn.active{background:rgba(124,92,252,.15);color:var(--accent)}
.nav-btn .ni{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.sidebar-bottom{padding:14px;border-top:1px solid var(--border)}

/* AUTH */
.auth-tabs{display:flex;gap:6px;margin-bottom:10px}
.auth-tab{flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text2);font-family:'Syne',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .12s}
.auth-tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
.auth-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:11px;outline:none;transition:border-color .15s;margin-bottom:7px;display:block}
.auth-input:focus{border-color:var(--accent)}
.auth-hint{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;text-align:center;margin-top:8px;line-height:1.5}
.user-card{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;flex-shrink:0}
.user-name{font-size:12px;font-weight:600}
.user-email{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px}

/* BUTTONS */
.btn{padding:8px 14px;border-radius:7px;border:none;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;font-size:12px;transition:all .15s;letter-spacing:.3px;display:inline-flex;align-items:center;gap:6px;line-height:1}
.btn-primary{background:linear-gradient(135deg,var(--accent),#9370ff);color:#fff}
.btn-primary:hover{opacity:.88;transform:translateY(-1px)}
.btn-primary:disabled{opacity:.45;transform:none;cursor:not-allowed}
.btn-ghost{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:rgba(252,92,125,.12);color:var(--accent2);border:1px solid rgba(252,92,125,.25)}
.btn-danger:hover{background:rgba(252,92,125,.2)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-full{width:100%;justify-content:center}

/* MAIN */
.main{grid-column:2;grid-row:1;overflow-y:auto;background:var(--bg)}
.page{display:none;padding:28px 32px;animation:fadeIn .15s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.page-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
.page-sub{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:2px;margin-top:3px;text-transform:uppercase}

/* SEARCH */
.search-wrap{position:relative;margin-bottom:18px}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:15px;pointer-events:none}
.search-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px 10px 36px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .15s}
.search-input:focus{border-color:var(--accent)}

/* HERO */
.hero{background:linear-gradient(135deg,rgba(124,92,252,.1),rgba(252,92,125,.05));border:1px solid var(--border);border-radius:14px;padding:30px;margin-bottom:26px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-80px;right:-80px;width:240px;height:240px;background:radial-gradient(circle,rgba(124,92,252,.18),transparent 70%);pointer-events:none}
.hero h1{font-size:30px;font-weight:800;letter-spacing:-1px;line-height:1.1;margin-bottom:8px}
.hero h1 span{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{color:var(--text2);font-size:13px;line-height:1.6;max-width:340px}
.hero-stats{display:flex;gap:24px;margin-top:18px}
.stat-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.stat-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1.5px;margin-top:1px}

/* SONGS TABLE */
.songs-header{display:grid;grid-template-columns:32px 1fr 150px 110px 70px 58px 60px;gap:10px;padding:5px 12px;border-bottom:1px solid var(--border);margin-bottom:3px}
.col-label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase}
.song-row{display:grid;grid-template-columns:32px 1fr 150px 110px 70px 58px 60px;gap:10px;align-items:center;padding:7px 12px;border-radius:8px;cursor:pointer;transition:background .1s;border:1px solid transparent}
.song-row:hover{background:var(--surface2)}
.song-row.playing{background:rgba(124,92,252,.09);border-color:rgba(124,92,252,.2)}
.song-num{font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);text-align:center}
.song-row.playing .song-num{color:var(--accent)}
.song-main{display:flex;align-items:center;gap:10px;min-width:0}
.song-cover{width:36px;height:36px;border-radius:6px;flex-shrink:0;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:15px;overflow:hidden}
.song-cover img{width:100%;height:100%;object-fit:cover}
.song-title-t{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.song-artist-t{font-size:11px;color:var(--text2);margin-top:1px}
.song-album-t{font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.genre-pill{display:inline-block;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:600;background:var(--surface3);color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.song-dur,.song-plays{font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);text-align:right}
.song-acts{display:flex;align-items:center;gap:2px}
.like-btn{background:none;border:none;cursor:pointer;font-size:14px;opacity:.3;transition:all .12s;padding:3px;line-height:1}
.like-btn:hover,.like-btn.liked{opacity:1}
.like-btn.liked{color:var(--accent2)}
.row-btns{display:flex;gap:2px;opacity:0;transition:opacity .12s}
.song-row:hover .row-btns{opacity:1}
.icon-btn{background:none;border:none;cursor:pointer;color:var(--text3);font-size:12px;padding:3px 4px;border-radius:4px;transition:all .12s}
.icon-btn:hover{background:var(--surface3);color:var(--text)}
.icon-btn.del:hover{color:var(--accent2)}

/* EQ */
.eq{display:flex;gap:2px;align-items:flex-end;height:14px}
.eq span{width:3px;background:var(--accent);border-radius:1px;animation:eq .5s ease-in-out infinite alternate}
.eq span:nth-child(2){animation-duration:.7s;animation-delay:.1s}
.eq span:nth-child(3){animation-duration:.4s;animation-delay:.2s}
@keyframes eq{from{height:3px}to{height:12px}}

/* EMPTY / LOADING */
.empty{text-align:center;padding:56px 20px;color:var(--text3)}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:.4}
.empty-text{font-size:13px}
.loading{display:flex;align-items:center;justify-content:center;padding:48px;color:var(--text3);gap:10px;font-size:13px}
.spinner{width:18px;height:18px;border:2px solid var(--surface3);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* UPLOAD */
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:44px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);position:relative}
.upload-zone:hover,.upload-zone.over{border-color:var(--accent);background:rgba(124,92,252,.05)}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:34px;margin-bottom:10px}
.upload-title{font-size:15px;font-weight:600;margin-bottom:5px}
.upload-hint{font-size:11px;color:var(--text2);font-family:'Space Mono',monospace}
.upload-form{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;margin-top:14px;display:none}
.upload-form.show{display:block}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:10px;font-weight:700;color:var(--text2);letter-spacing:.8px;text-transform:uppercase}
.form-input{background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px 12px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .15s}
.form-input:focus{border-color:var(--accent)}
.cover-row{display:flex;gap:14px;align-items:flex-start;margin-bottom:14px}
.cover-thumb{width:76px;height:76px;border-radius:8px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;overflow:hidden;border:1px solid var(--border);cursor:pointer;position:relative}
.cover-thumb img{width:100%;height:100%;object-fit:cover}
.cover-thumb input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.form-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.upload-status{font-size:11px;color:var(--text2);font-family:'Space Mono',monospace}

/* PLAYLISTS */
.pl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin-bottom:22px}
.pl-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all .15s;position:relative}
.pl-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.pl-cover{width:100%;aspect-ratio:1;border-radius:8px;background:linear-gradient(135deg,var(--surface3),var(--surface2));display:flex;align-items:center;justify-content:center;font-size:30px;margin-bottom:10px}
.pl-name{font-size:13px;font-weight:600;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pl-count{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace}
.pl-del{position:absolute;top:8px;right:8px;background:rgba(252,92,125,.15);border:none;border-radius:5px;cursor:pointer;color:var(--accent2);font-size:11px;padding:3px 6px;opacity:0;transition:opacity .12s}
.pl-card:hover .pl-del{opacity:1}
.pl-new{background:var(--surface);border:2px dashed var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-height:150px}
.pl-new:hover{border-color:var(--accent)}
.pl-new-icon{font-size:26px;opacity:.4}
.pl-new-text{font-size:12px;font-weight:600;color:var(--text2)}

/* HISTORY */
.hist-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;border-bottom:1px solid var(--border);cursor:pointer}
.hist-item:hover{background:var(--surface2)}
.hist-time{font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);margin-left:auto;flex-shrink:0}

/* STATS CARDS */
.stat-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.stat-card-icon{font-size:20px;margin-bottom:6px}
.stat-card-val{font-size:22px;font-weight:800}
.stat-card-label{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:1px;margin-top:4px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:100%;max-width:380px;animation:fadeIn .15s ease}
.modal-title{font-size:17px;font-weight:700;margin-bottom:16px;letter-spacing:-.3px}
.modal-actions{display:flex;gap:8px;margin-top:16px}

/* PLAYER */
.player{grid-column:1/-1;grid-row:2;background:rgba(8,8,15,.96);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:grid;grid-template-columns:240px 1fr 200px;align-items:center;padding:0 22px;gap:16px;height:var(--ph)}
.now-playing{display:flex;align-items:center;gap:12px;min-width:0}
.now-cover{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;overflow:hidden}
.now-cover img{width:100%;height:100%;object-fit:cover}
.now-title{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.now-artist{font-size:11px;color:var(--text2);margin-top:2px}
.now-like{background:none;border:none;cursor:pointer;font-size:15px;opacity:.3;transition:all .12s;flex-shrink:0;padding:4px}
.now-like:hover,.now-like.liked{opacity:1;color:var(--accent2)}
.ctrl-area{display:flex;flex-direction:column;align-items:center;gap:10px}
.ctrl-btns{display:flex;align-items:center;gap:14px}
.ctrl-btn{background:none;border:none;cursor:pointer;color:var(--text2);font-size:16px;transition:all .12s;padding:4px}
.ctrl-btn:hover{color:var(--text);transform:scale(1.1)}
.ctrl-btn.on{color:var(--accent)}
.play-btn{width:36px;height:36px;border-radius:50%;background:var(--text);color:var(--bg);font-size:14px;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;transition:all .15s;flex-shrink:0}
.play-btn:hover{background:var(--accent);color:#fff;transform:scale(1.06)}
.prog-row{display:flex;align-items:center;gap:10px;width:100%;max-width:500px}
.t-label{font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);width:28px;flex-shrink:0}
.t-label:last-child{text-align:right}
.prog-track{flex:1;height:3px;background:var(--surface3);border-radius:99px;cursor:pointer;position:relative}
.prog-track:hover{height:5px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:99px;pointer-events:none;transition:width .4s linear}
.vol-row{display:flex;align-items:center;justify-content:flex-end;gap:8px}
.vol-icon{font-size:14px;color:var(--text2);cursor:pointer;user-select:none}
input[type=range].vol{-webkit-appearance:none;width:78px;height:3px;background:var(--surface3);border-radius:99px;outline:none;cursor:pointer}
input[type=range].vol::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--text);cursor:pointer}

/* TOAST */
.toasts{position:fixed;bottom:calc(var(--ph) + 10px);right:16px;display:flex;flex-direction:column;gap:6px;z-index:9998}
.toast{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:12px;font-weight:500;animation:slideIn .2s ease;display:flex;align-items:center;gap:7px;max-width:280px}
.toast.ok{border-color:var(--accent3);color:var(--accent3)}
.toast.err{border-color:var(--accent2);color:var(--accent2)}
.toast.info{border-color:var(--accent);color:var(--accent)}
@keyframes slideIn{from{transform:translateX(14px);opacity:0}to{transform:translateX(0);opacity:1}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:99px}
audio{display:none}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-mark">SOUNDWAVE</div>
    <div class="logo-sub">// YOUR MUSIC</div>
  </div>
  <div class="nav-scroll">
    <div class="nav-section">
      <div class="nav-label">Browse</div>
      <button class="nav-btn active" onclick="goTo('home')"><span class="ni">‚ö°</span>Home</button>
      <button class="nav-btn" onclick="goTo('library')"><span class="ni">üéµ</span>Library</button>
      <button class="nav-btn" onclick="goTo('liked')"><span class="ni">‚ô°</span>Liked Songs</button>
      <button class="nav-btn" onclick="goTo('history')"><span class="ni">üïê</span>History</button>
    </div>
    <div class="nav-section">
      <div class="nav-label">My Music</div>
      <button class="nav-btn" onclick="goTo('upload')"><span class="ni">‚Üë</span>Upload</button>
      <button class="nav-btn" onclick="goTo('playlists')"><span class="ni">‚ò∞</span>Playlists</button>
      <button class="nav-btn" onclick="goTo('profile')"><span class="ni">‚óâ</span>Profile</button>
    </div>
  </div>
  <div class="sidebar-bottom" id="sidebarBottom"></div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- HOME -->
  <div class="page active" id="p-home">
    <div class="hero">
      <h1>Your Sound,<br><span>Amplified.</span></h1>
      <p>Upload, discover, and play your personal music library.</p>
      <div class="hero-stats">
        <div><div class="stat-val" id="stSongs">‚Äî</div><div class="stat-label">TRACKS</div></div>
        <div><div class="stat-val" id="stLiked">‚Äî</div><div class="stat-label">LIKED</div></div>
        <div><div class="stat-val" id="stPlayed">‚Äî</div><div class="stat-label">PLAYED</div></div>
      </div>
    </div>
    <div class="page-header">
      <div><div class="page-title">All Songs</div></div>
      <button class="btn btn-primary btn-sm" onclick="goTo('upload')">‚Üë Upload</button>
    </div>
    <div class="search-wrap"><span class="search-icon">‚åï</span><input class="search-input" placeholder="Search songs, artists, albums‚Ä¶" oninput="filterSongs(this.value,'homeList')"></div>
    <div class="songs-header"><div class="col-label">#</div><div class="col-label">Title</div><div class="col-label">Album</div><div class="col-label">Genre</div><div class="col-label" style="text-align:right">Plays</div><div class="col-label" style="text-align:right">Time</div><div></div></div>
    <div id="homeList"><div class="loading"><div class="spinner"></div>Loading‚Ä¶</div></div>
  </div>

  <!-- LIBRARY -->
  <div class="page" id="p-library">
    <div class="page-header"><div><div class="page-title">Library</div><div class="page-sub">all public tracks</div></div></div>
    <div class="search-wrap"><span class="search-icon">‚åï</span><input class="search-input" placeholder="Search‚Ä¶" oninput="filterSongs(this.value,'libraryList')"></div>
    <div class="songs-header"><div class="col-label">#</div><div class="col-label">Title</div><div class="col-label">Album</div><div class="col-label">Genre</div><div class="col-label" style="text-align:right">Plays</div><div class="col-label" style="text-align:right">Time</div><div></div></div>
    <div id="libraryList"><div class="loading"><div class="spinner"></div>Loading‚Ä¶</div></div>
  </div>

  <!-- LIKED -->
  <div class="page" id="p-liked">
    <div class="page-header">
      <div style="display:flex;align-items:center;gap:14px">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),#ff8fa3);display:flex;align-items:center;justify-content:center;font-size:26px">‚ô•</div>
        <div><div class="page-title">Liked Songs</div><div class="page-sub" id="likedSub">0 tracks</div></div>
      </div>
    </div>
    <div class="songs-header"><div class="col-label">#</div><div class="col-label">Title</div><div class="col-label">Album</div><div class="col-label">Genre</div><div class="col-label" style="text-align:right">Plays</div><div class="col-label" style="text-align:right">Time</div><div></div></div>
    <div id="likedList"></div>
  </div>

  <!-- HISTORY -->
  <div class="page" id="p-history">
    <div class="page-header"><div><div class="page-title">Play History</div><div class="page-sub">recently played</div></div></div>
    <div id="historyList"><div class="loading"><div class="spinner"></div>Loading‚Ä¶</div></div>
  </div>

  <!-- UPLOAD -->
  <div class="page" id="p-upload">
    <div class="page-header"><div><div class="page-title">Upload Music</div><div class="page-sub">add to your library</div></div></div>
    <div id="uploadGate"><div class="empty"><div class="empty-icon">üîí</div><div class="empty-text">Sign in to upload music</div></div></div>
    <div id="uploadContent" style="display:none">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="audioFile" accept="audio/*">
        <div class="upload-icon">‚ô™</div>
        <div class="upload-title">Drop audio file here or click to browse</div>
        <div class="upload-hint">MP3, FLAC, WAV, AAC, OGG ‚Äî max 50 MB</div>
      </div>
      <div class="upload-form" id="uploadForm">
        <div class="cover-row">
          <div class="cover-thumb" id="coverThumb" title="Click to add cover art">
            <input type="file" id="coverFile" accept="image/*">
            <span id="coverIcon">üéµ</span>
          </div>
          <div><div class="form-label" style="margin-bottom:5px">Cover Art (Optional)</div><div style="font-size:11px;color:var(--text2);line-height:1.5">Click the thumbnail to add album art.<br>JPG or PNG recommended.</div></div>
        </div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Title *</label><input class="form-input" id="fTitle" placeholder="Song title"></div>
          <div class="form-group"><label class="form-label">Artist *</label><input class="form-input" id="fArtist" placeholder="Artist name"></div>
          <div class="form-group"><label class="form-label">Album</label><input class="form-input" id="fAlbum" placeholder="Album name"></div>
          <div class="form-group"><label class="form-label">Genre</label><input class="form-input" id="fGenre" placeholder="e.g. Electronic, Jazz‚Ä¶"></div>
        </div>
        <div class="form-row">
          <button class="btn btn-primary" id="uploadBtn" onclick="doUpload()">‚Üë Upload Song</button>
          <button class="btn btn-ghost" onclick="cancelUpload()">Cancel</button>
          <span class="upload-status" id="uploadStatus"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYLISTS -->
  <div class="page" id="p-playlists">
    <div class="page-header"><div><div class="page-title">Playlists</div></div><button class="btn btn-primary btn-sm" onclick="showCreatePl()">+ New</button></div>
    <div class="pl-grid" id="plGrid"><div class="loading"><div class="spinner"></div>Loading‚Ä¶</div></div>
    <div id="plDetail" style="display:none">
      <button class="btn btn-ghost btn-sm" onclick="hidePlDetail()" style="margin-bottom:16px">‚Üê Back</button>
      <div class="page-header">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:26px">üìª</div>
          <div><div class="page-title" id="plDetailName">Playlist</div><div class="page-sub" id="plDetailSub"></div></div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="playCurrentPlaylist()">‚ñ∂ Play All</button>
      </div>
      <div class="songs-header"><div class="col-label">#</div><div class="col-label">Title</div><div class="col-label">Album</div><div class="col-label">Genre</div><div class="col-label" style="text-align:right">Plays</div><div class="col-label" style="text-align:right">Time</div><div></div></div>
      <div id="plDetailList"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="page" id="p-profile">
    <div class="page-header"><div><div class="page-title">Profile</div></div></div>
    <div id="profileBody"></div>
  </div>

</main>

<!-- PLAYER -->
<div class="player">
  <div class="now-playing">
    <div class="now-cover" id="nowCover">‚ô™</div>
    <div style="min-width:0">
      <div class="now-title" id="nowTitle">Nothing playing</div>
      <div class="now-artist" id="nowArtist">Select a track</div>
    </div>
    <button class="now-like" id="nowLike" onclick="toggleLikeNow()">‚ô°</button>
  </div>
  <div class="ctrl-area">
    <div class="ctrl-btns">
      <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">‚áÑ</button>
      <button class="ctrl-btn" onclick="prevTrack()" title="Previous">‚èÆ</button>
      <button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
      <button class="ctrl-btn" onclick="nextTrack()" title="Next">‚è≠</button>
      <button class="ctrl-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">‚Ü∫</button>
    </div>
    <div class="prog-row">
      <span class="t-label" id="tCur">0:00</span>
      <div class="prog-track" id="progTrack" onclick="seek(event)"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
      <span class="t-label" id="tTot">0:00</span>
    </div>
  </div>
  <div class="vol-row">
    <span class="vol-icon" id="volIcon" onclick="toggleMute()">üîä</span>
    <input type="range" class="vol" id="volRange" min="0" max="100" value="80" oninput="setVol(this.value)">
  </div>
</div>
</div>

<!-- MODAL: Create Playlist -->
<div class="overlay" id="mCreatePl">
  <div class="modal">
    <div class="modal-title">New Playlist</div>
    <div class="form-group" style="margin-bottom:10px"><label class="form-label">Name *</label><input class="form-input" id="plNameInput" placeholder="My Playlist" style="margin-top:4px" onkeydown="if(event.key==='Enter')createPlaylist()"></div>
    <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="plDescInput" placeholder="Optional‚Ä¶" style="margin-top:4px"></div>
    <div class="modal-actions"><button class="btn btn-primary btn-full" onclick="createPlaylist()">Create</button><button class="btn btn-ghost" onclick="closeModal('mCreatePl')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: Add to Playlist -->
<div class="overlay" id="mAddToPl">
  <div class="modal">
    <div class="modal-title">Add to Playlist</div>
    <div id="plPickList" style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;margin-bottom:10px"></div>
    <button class="btn btn-ghost btn-full" onclick="closeModal('mAddToPl')">Cancel</button>
  </div>
</div>

<div class="toasts" id="toasts"></div>
<audio id="aud"></audio>

<script>
const SB_URL='https://dimyxktddajqtyvvambr.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpbXl4a3RkZGFqcXR5dnZhbWJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDI1OTcsImV4cCI6MjA4NjkxODU5N30.my11U7XytKfWwM602O3-J7mIpclNTZgEXJmOLQ68HXM';
const sb=supabase.createClient(SB_URL,SB_KEY);
const aud=document.getElementById('aud');

let S={user:null,songs:[],queue:[],qIdx:-1,playing:false,shuffle:false,repeat:false,likes:new Set(),muted:false,pendingAudio:null,pendingCoverBlob:null,curPl:null};
let addToPl_songId=null;

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê
(async()=>{
  const{data:{session}}=await sb.auth.getSession();
  if(session?.user) await onLogin(session.user); else renderAuthForm();
  sb.auth.onAuthStateChange(async(_,sess)=>{
    if(sess?.user) await onLogin(sess.user);
    else{S.user=null;S.likes.clear();renderAuthForm();refreshAll();}
  });
  await loadSongs();
  setupFileInputs();
})();

async function onLogin(u){
  S.user=u;renderUserCard();
  await loadLikes();refreshAll();loadStats();
}

// ‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê
async function loadSongs(){
  const{data,error}=await sb.from('songs').select('*').eq('is_public',true).order('created_at',{ascending:false});
  if(error){toast('Could not load songs: '+error.message,'err');return;}
  S.songs=data||[];S.queue=[...S.songs];
  renderList('homeList',S.songs);renderList('libraryList',S.songs);
  document.getElementById('stSongs').textContent=S.songs.length;
}

async function loadLikes(){
  if(!S.user)return;
  const{data}=await sb.from('likes').select('song_id').eq('user_id',S.user.id);
  S.likes=new Set((data||[]).map(r=>r.song_id));
  document.getElementById('stLiked').textContent=S.likes.size;
}

async function loadStats(){
  if(!S.user)return;
  const{count}=await sb.from('play_history').select('*',{count:'exact',head:true}).eq('user_id',S.user.id);
  document.getElementById('stPlayed').textContent=count||0;
}

// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function renderList(id,songs,opts={}){
  const el=document.getElementById(id);
  if(!songs.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üéµ</div><div class="empty-text">${opts.empty||'No songs found'}</div></div>`;return;}
  el.innerHTML=songs.map((s,i)=>songRow(s,i,opts)).join('');
}

function songRow(s,i,opts={}){
  const playing=S.qIdx>=0&&S.queue[S.qIdx]?.id===s.id&&S.playing;
  const liked=S.likes.has(s.id);
  const num=playing?`<div class="eq"><span></span><span></span><span></span></div>`:`${i+1}`;
  const cover=s.cover_url?`<img src="${x(s.cover_url)}" alt="">`:'üéµ';
  const dur=s.duration?fmt(s.duration):'‚Äî';
  const addBtn=S.user?`<button class="icon-btn" onclick="openAddToPl(event,'${s.id}')" title="Add to playlist">+</button>`:'';
  const delBtn=S.user&&s.user_id===S.user.id?`<button class="icon-btn del" onclick="delSong(event,'${s.id}')" title="Delete">üóë</button>`:'';
  const rmBtn=opts.rm?`<button class="icon-btn del" onclick="rmFromPl(event,'${s.id}')" title="Remove">‚úï</button>`:'';
  return`<div class="song-row${playing?' playing':''}" onclick="playSong('${s.id}')">
    <div class="song-num">${num}</div>
    <div class="song-main"><div class="song-cover">${cover}</div><div><div class="song-title-t">${x(s.title)}</div><div class="song-artist-t">${x(s.artist)}</div></div></div>
    <div class="song-album-t">${x(s.album||'‚Äî')}</div>
    <div><span class="genre-pill">${x(s.genre||'‚Äî')}</span></div>
    <div class="song-plays">${s.play_count||0}</div>
    <div class="song-dur">${dur}</div>
    <div class="song-acts"><button class="like-btn${liked?' liked':''}" onclick="toggleLike(event,'${s.id}')">${liked?'‚ô•':'‚ô°'}</button><div class="row-btns">${addBtn}${rmBtn}${delBtn}</div></div>
  </div>`;
}

function filterSongs(q,lid){
  const f=q.toLowerCase();
  const res=f?S.songs.filter(s=>s.title.toLowerCase().includes(f)||s.artist.toLowerCase().includes(f)||(s.album||'').toLowerCase().includes(f)||(s.genre||'').toLowerCase().includes(f)):S.songs;
  renderList(lid,res,{empty:'No songs match your search'});
}

function refreshAll(){
  renderList('homeList',S.songs);
  renderList('libraryList',S.songs);
  renderLiked();
  if(S.curPl)renderPlDetail(S.curPl.id);
}

// ‚ïê‚ïê‚ïê PLAYBACK ‚ïê‚ïê‚ïê
function playSong(id){
  const idx=S.queue.findIndex(s=>s.id===id);
  if(idx<0)return;
  S.qIdx=idx;
  const s=S.queue[idx];
  aud.src=s.file_url;
  aud.volume=document.getElementById('volRange').value/100;
  aud.play().then(()=>{S.playing=true;updatePlayer(s);refreshAll();recordPlay(s.id);}).catch(e=>toast('Playback error: '+e.message,'err'));
}

function togglePlay(){if(!aud.src)return;S.playing?aud.pause():aud.play();}
function nextTrack(){if(!S.queue.length)return;const n=S.shuffle?Math.floor(Math.random()*S.queue.length):(S.qIdx+1)%S.queue.length;playSong(S.queue[n].id);}
function prevTrack(){if(!S.queue.length)return;if(aud.currentTime>3){aud.currentTime=0;return;}const p=(S.qIdx-1+S.queue.length)%S.queue.length;playSong(S.queue[p].id);}
function toggleShuffle(){S.shuffle=!S.shuffle;document.getElementById('shuffleBtn').classList.toggle('on',S.shuffle);}
function toggleRepeat(){S.repeat=!S.repeat;document.getElementById('repeatBtn').classList.toggle('on',S.repeat);}
function toggleMute(){S.muted=!S.muted;aud.muted=S.muted;document.getElementById('volIcon').textContent=S.muted?'üîá':'üîä';}
function setVol(v){aud.volume=v/100;document.getElementById('volIcon').textContent=v==0?'üîá':v<50?'üîâ':'üîä';}
function seek(e){const t=document.getElementById('progTrack');if(aud.duration)aud.currentTime=((e.clientX-t.getBoundingClientRect().left)/t.offsetWidth)*aud.duration;}

aud.addEventListener('timeupdate',()=>{if(!aud.duration)return;document.getElementById('progFill').style.width=(aud.currentTime/aud.duration*100)+'%';document.getElementById('tCur').textContent=fmt(Math.floor(aud.currentTime));});
aud.addEventListener('loadedmetadata',()=>document.getElementById('tTot').textContent=fmt(Math.floor(aud.duration)));
aud.addEventListener('ended',()=>{if(S.repeat){aud.currentTime=0;aud.play();}else nextTrack();});
aud.addEventListener('play',()=>{S.playing=true;document.getElementById('playBtn').textContent='‚è∏';});
aud.addEventListener('pause',()=>{S.playing=false;document.getElementById('playBtn').textContent='‚ñ∂';});

function updatePlayer(s){
  document.getElementById('nowTitle').textContent=s.title;
  document.getElementById('nowArtist').textContent=s.artist;
  const c=document.getElementById('nowCover');
  c.innerHTML=s.cover_url?`<img src="${x(s.cover_url)}" style="width:100%;height:100%;object-fit:cover">`:'‚ô™';
  const nl=document.getElementById('nowLike');
  nl.textContent=S.likes.has(s.id)?'‚ô•':'‚ô°';
  nl.classList.toggle('liked',S.likes.has(s.id));
}

// ‚ïê‚ïê‚ïê LIKES ‚ïê‚ïê‚ïê
async function toggleLike(e,id){
  e.stopPropagation();
  if(!S.user){toast('Sign in to like songs','err');return;}
  if(S.likes.has(id)){await sb.from('likes').delete().eq('user_id',S.user.id).eq('song_id',id);S.likes.delete(id);}
  else{await sb.from('likes').insert({user_id:S.user.id,song_id:id});S.likes.add(id);}
  document.getElementById('stLiked').textContent=S.likes.size;
  refreshAll();
  const cur=S.queue[S.qIdx];
  if(cur&&cur.id===id){const nl=document.getElementById('nowLike');nl.textContent=S.likes.has(id)?'‚ô•':'‚ô°';nl.classList.toggle('liked',S.likes.has(id));}
}

async function toggleLikeNow(){const cur=S.queue[S.qIdx];if(!cur)return;await toggleLike({stopPropagation:()=>{}},cur.id);}

function renderLiked(){
  const liked=S.songs.filter(s=>S.likes.has(s.id));
  document.getElementById('likedSub').textContent=`${liked.length} track${liked.length!==1?'s':''}`;
  renderList('likedList',liked,{empty:'Like songs to see them here'});
}

// ‚ïê‚ïê‚ïê PLAY HISTORY ‚ïê‚ïê‚ïê
async function recordPlay(id){
  await sb.from('play_history').insert({song_id:id,user_id:S.user?.id||null});
  const s=S.songs.find(s=>s.id===id);
  if(s){s.play_count=(s.play_count||0)+1;await sb.from('songs').update({play_count:s.play_count}).eq('id',id);}
  loadStats();
}

async function loadHistory(){
  const el=document.getElementById('historyList');
  if(!S.user){el.innerHTML=`<div class="empty"><div class="empty-icon">üîí</div><div class="empty-text">Sign in to view history</div></div>`;return;}
  const{data}=await sb.from('play_history').select('played_at,songs(id,title,artist,cover_url)').eq('user_id',S.user.id).order('played_at',{ascending:false}).limit(60);
  if(!data?.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üïê</div><div class="empty-text">No history yet</div></div>`;return;}
  el.innerHTML=data.map(r=>{
    const s=r.songs;if(!s)return'';
    const cover=s.cover_url?`<img src="${x(s.cover_url)}" style="width:100%;height:100%;object-fit:cover">`:'üéµ';
    const t=new Date(r.played_at).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    return`<div class="hist-item" onclick="playSong('${s.id}')"><div class="song-cover" style="width:36px;height:36px">${cover}</div><div><div style="font-size:13px;font-weight:600">${x(s.title)}</div><div style="font-size:11px;color:var(--text2)">${x(s.artist)}</div></div><span class="hist-time">${t}</span></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê UPLOAD ‚ïê‚ïê‚ïê
function setupFileInputs(){
  const zone=document.getElementById('uploadZone');
  const aInp=document.getElementById('audioFile');
  const cInp=document.getElementById('coverFile');
  aInp.addEventListener('change',e=>{if(e.target.files[0])prepUpload(e.target.files[0]);});
  cInp.addEventListener('change',e=>{if(e.target.files[0])prevCover(e.target.files[0]);});
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('over');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('over'));
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.classList.remove('over');
    const f=[...e.dataTransfer.files].find(f=>f.type.startsWith('audio/'));
    if(f)prepUpload(f);
  });
}

function prepUpload(file){
  if(!S.user){toast('Sign in to upload','err');return;}
  S.pendingAudio=file;
  const base=file.name.replace(/\.[^/.]+$/,'');
  const parts=base.split(/\s*[-‚Äì‚Äî]\s*/);
  if(parts.length>=2){document.getElementById('fArtist').value=parts[0];document.getElementById('fTitle').value=parts.slice(1).join(' - ');}
  else document.getElementById('fTitle').value=base;
  document.getElementById('uploadForm').classList.add('show');
  document.getElementById('uploadStatus').textContent=`üìé ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`;
}

function prevCover(file){
  S.pendingCoverBlob=file;
  const r=new FileReader();
  r.onload=e=>{
    const t=document.getElementById('coverThumb');
    t.innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover"><input type="file" id="coverFile" accept="image/*">`;
    document.getElementById('coverFile').addEventListener('change',ev=>{if(ev.target.files[0])prevCover(ev.target.files[0]);});
  };
  r.readAsDataURL(file);
}

function cancelUpload(){
  S.pendingAudio=null;S.pendingCoverBlob=null;
  document.getElementById('uploadForm').classList.remove('show');
  document.getElementById('audioFile').value='';
  ['fTitle','fArtist','fAlbum','fGenre'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('uploadStatus').textContent='';
  const t=document.getElementById('coverThumb');
  t.innerHTML=`<input type="file" id="coverFile" accept="image/*"><span id="coverIcon">üéµ</span>`;
  document.getElementById('coverFile').addEventListener('change',e=>{if(e.target.files[0])prevCover(e.target.files[0]);});
}

async function doUpload(){
  if(!S.user){toast('Sign in first','err');return;}
  if(!S.pendingAudio){toast('Select an audio file','err');return;}
  const title=document.getElementById('fTitle').value.trim();
  const artist=document.getElementById('fArtist').value.trim();
  if(!title||!artist){toast('Title and artist are required','err');return;}

  const btn=document.getElementById('uploadBtn');
  const status=document.getElementById('uploadStatus');
  btn.disabled=true;btn.textContent='Uploading‚Ä¶';

  try{
    // 1. Upload audio to storage
    status.textContent='‚è≥ Uploading audio file‚Ä¶';
    const ext=S.pendingAudio.name.split('.').pop().toLowerCase();
    const audioPath=`${S.user.id}/${Date.now()}.${ext}`;
    const{error:aErr}=await sb.storage.from('songs').upload(audioPath,S.pendingAudio,{contentType:S.pendingAudio.type||'audio/mpeg',upsert:false});
    if(aErr)throw new Error('Audio upload failed: '+aErr.message);
    const{data:{publicUrl:audioUrl}}=sb.storage.from('songs').getPublicUrl(audioPath);

    // 2. Upload cover art if provided
    let coverUrl=null;
    if(S.pendingCoverBlob){
      status.textContent='‚è≥ Uploading cover art‚Ä¶';
      const cExt=S.pendingCoverBlob.name.split('.').pop().toLowerCase();
      const coverPath=`${S.user.id}/${Date.now()}_cover.${cExt}`;
      const{error:cErr}=await sb.storage.from('covers').upload(coverPath,S.pendingCoverBlob,{contentType:S.pendingCoverBlob.type||'image/jpeg',upsert:false});
      if(!cErr){const{data:{publicUrl}}=sb.storage.from('covers').getPublicUrl(coverPath);coverUrl=publicUrl;}
    }

    // 3. Get audio duration
    status.textContent='‚è≥ Processing audio‚Ä¶';
    let duration=null;
    try{duration=await new Promise((res,rej)=>{const a=new Audio();a.preload='metadata';const u=URL.createObjectURL(S.pendingAudio);a.onloadedmetadata=()=>{res(Math.floor(a.duration));URL.revokeObjectURL(u);};a.onerror=()=>rej();a.src=u;setTimeout(()=>rej(),8000);});}catch{}

    // 4. Insert into songs table
    status.textContent='‚è≥ Saving to library‚Ä¶';
    const{error:dbErr}=await sb.from('songs').insert({
      user_id:S.user.id,title,artist,
      album:document.getElementById('fAlbum').value.trim()||null,
      genre:document.getElementById('fGenre').value.trim()||null,
      file_url:audioUrl,cover_url:coverUrl,
      file_size:S.pendingAudio.size,duration,is_public:true
    });
    if(dbErr)throw new Error('Save failed: '+dbErr.message);

    toast('Song uploaded! üéµ','ok');
    cancelUpload();
    await loadSongs();
    goTo('home');
  }catch(err){
    toast(err.message,'err');
  }finally{
    btn.disabled=false;btn.textContent='‚Üë Upload Song';
  }
}

async function delSong(e,id){
  e.stopPropagation();
  if(!confirm('Delete this song?'))return;
  const{error}=await sb.from('songs').delete().eq('id',id).eq('user_id',S.user.id);
  if(error){toast('Delete failed: '+error.message,'err');return;}
  S.songs=S.songs.filter(s=>s.id!==id);S.queue=S.queue.filter(s=>s.id!==id);
  if(S.queue[S.qIdx]?.id===id){S.qIdx=-1;S.playing=false;aud.pause();aud.src='';}
  refreshAll();toast('Song deleted','ok');
}

// ‚ïê‚ïê‚ïê PLAYLISTS ‚ïê‚ïê‚ïê
async function loadPlaylists(){
  const g=document.getElementById('plGrid');
  const{data}=await sb.from('playlists').select('*, playlist_songs(count)').order('created_at',{ascending:false});
  if(!data?.length){g.innerHTML=`<div class="pl-new" onclick="showCreatePl()"><div class="pl-new-icon">+</div><div class="pl-new-text">Create First Playlist</div></div>`;return;}
  g.innerHTML=data.map(p=>`
    <div class="pl-card" onclick="openPl('${p.id}','${x(p.name)}')">
      <button class="pl-del" onclick="delPl(event,'${p.id}')">‚úï</button>
      <div class="pl-cover">üìª</div>
      <div class="pl-name">${x(p.name)}</div>
      <div class="pl-count">${p.playlist_songs?.[0]?.count||0} tracks</div>
    </div>`).join('')+`<div class="pl-new" onclick="showCreatePl()"><div class="pl-new-icon">+</div><div class="pl-new-text">New Playlist</div></div>`;
}

function showCreatePl(){
  if(!S.user){toast('Sign in to create playlists','err');return;}
  document.getElementById('plNameInput').value='';document.getElementById('plDescInput').value='';
  document.getElementById('mCreatePl').classList.add('show');
  setTimeout(()=>document.getElementById('plNameInput').focus(),50);
}

async function createPlaylist(){
  const name=document.getElementById('plNameInput').value.trim();
  if(!name){toast('Name required','err');return;}
  const{error}=await sb.from('playlists').insert({user_id:S.user.id,name,description:document.getElementById('plDescInput').value.trim()||null});
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('mCreatePl');toast('Playlist created!','ok');loadPlaylists();
}

async function delPl(e,id){
  e.stopPropagation();if(!confirm('Delete this playlist?'))return;
  await sb.from('playlist_songs').delete().eq('playlist_id',id);
  await sb.from('playlists').delete().eq('id',id);
  toast('Deleted','ok');loadPlaylists();hidePlDetail();
}

async function openPl(id,name){
  S.curPl={id,name};
  document.getElementById('plDetailName').textContent=name;
  document.getElementById('plGrid').style.display='none';
  document.getElementById('plDetail').style.display='block';
  renderPlDetail(id);
}

async function renderPlDetail(id){
  const{data}=await sb.from('playlist_songs').select('position,songs(*)').eq('playlist_id',id).order('position');
  const songs=(data||[]).map(r=>r.songs).filter(Boolean);
  S.curPl.songs=songs;
  document.getElementById('plDetailSub').textContent=`${songs.length} tracks`;
  renderList('plDetailList',songs,{empty:'No songs in this playlist',rm:true});
}

async function rmFromPl(e,songId){
  e.stopPropagation();if(!S.curPl)return;
  await sb.from('playlist_songs').delete().eq('playlist_id',S.curPl.id).eq('song_id',songId);
  toast('Removed','ok');renderPlDetail(S.curPl.id);
}

function hidePlDetail(){S.curPl=null;document.getElementById('plDetail').style.display='none';document.getElementById('plGrid').style.display='grid';}

function playCurrentPlaylist(){
  if(!S.curPl?.songs?.length)return;
  S.queue=[...S.curPl.songs];S.qIdx=-1;playSong(S.queue[0].id);
}

async function openAddToPl(e,songId){
  e.stopPropagation();
  if(!S.user){toast('Sign in first','err');return;}
  addToPl_songId=songId;
  const{data}=await sb.from('playlists').select('id,name').eq('user_id',S.user.id).order('created_at',{ascending:false});
  const list=document.getElementById('plPickList');
  if(!data?.length){list.innerHTML=`<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px">No playlists yet.<br><button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="closeModal('mAddToPl');showCreatePl()">Create one</button></div>`;}
  else list.innerHTML=data.map(p=>`<button class="btn btn-ghost btn-full" onclick="addToPlDo('${p.id}')">${x(p.name)}</button>`).join('');
  document.getElementById('mAddToPl').classList.add('show');
}

async function addToPlDo(plId){
  const{data:ex}=await sb.from('playlist_songs').select('id').eq('playlist_id',plId).eq('song_id',addToPl_songId);
  if(ex?.length){toast('Already in playlist','info');closeModal('mAddToPl');return;}
  const{count}=await sb.from('playlist_songs').select('*',{count:'exact',head:true}).eq('playlist_id',plId);
  await sb.from('playlist_songs').insert({playlist_id:plId,song_id:addToPl_songId,position:(count||0)+1});
  toast('Added to playlist!','ok');closeModal('mAddToPl');
}

// ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê
async function loadProfile(){
  const el=document.getElementById('profileBody');
  if(!S.user){el.innerHTML=`<div class="empty"><div class="empty-icon">üîí</div><div class="empty-text">Sign in to view your profile</div></div>`;return;}
  const{data:prof}=await sb.from('profiles').select('*').eq('id',S.user.id).single();
  const mine=S.songs.filter(s=>s.user_id===S.user.id);
  const totalPlays=mine.reduce((a,s)=>a+(s.play_count||0),0);
  const letter=(S.user.email||'U')[0].toUpperCase();
  const name=prof?.username||S.user.user_metadata?.username||S.user.email?.split('@')[0]||'User';
  el.innerHTML=`
    <div style="display:flex;align-items:center;gap:18px;margin-bottom:26px">
      <div class="avatar" style="width:58px;height:58px;font-size:22px">${letter}</div>
      <div>
        <div style="font-size:20px;font-weight:700">${x(name)}</div>
        <div style="font-size:11px;color:var(--text2);font-family:'Space Mono',monospace;margin-top:3px">${x(S.user.email||'')}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:6px">Member since ${new Date(S.user.created_at||Date.now()).toLocaleDateString()}</div>
      </div>
    </div>
    <div class="stat-cards">
      <div class="stat-card"><div class="stat-card-icon">üéµ</div><div class="stat-card-val">${mine.length}</div><div class="stat-card-label">Uploaded</div></div>
      <div class="stat-card"><div class="stat-card-icon">‚ô•</div><div class="stat-card-val">${S.likes.size}</div><div class="stat-card-label">Liked</div></div>
      <div class="stat-card"><div class="stat-card-icon">‚ñ∂</div><div class="stat-card-val">${totalPlays}</div><div class="stat-card-label">Total Plays</div></div>
    </div>
    <div class="page-header" style="margin-bottom:14px"><div class="page-title" style="font-size:17px">My Uploads</div></div>
    <div class="songs-header"><div class="col-label">#</div><div class="col-label">Title</div><div class="col-label">Album</div><div class="col-label">Genre</div><div class="col-label" style="text-align:right">Plays</div><div class="col-label" style="text-align:right">Time</div><div></div></div>
    <div id="profileSongs"></div>
    <button class="btn btn-danger" style="margin-top:24px" onclick="doSignOut()">Sign Out</button>`;
  renderList('profileSongs',mine,{empty:"You haven't uploaded anything yet"});
}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function renderAuthForm(){
  document.getElementById('sidebarBottom').innerHTML=`
    <div>
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabIn" onclick="switchTab('in')">Sign In</button>
        <button class="auth-tab" id="tabUp" onclick="switchTab('up')">Sign Up</button>
      </div>
      <input class="auth-input" id="aEmail" type="email" placeholder="your@email.com" onkeydown="if(event.key==='Enter')doAuth()">
      <input class="auth-input" id="aPass" type="password" placeholder="Password (min 6 chars)" onkeydown="if(event.key==='Enter')doAuth()">
      <div id="aNameWrap" style="display:none"><input class="auth-input" id="aName" placeholder="Display name (optional)" onkeydown="if(event.key==='Enter')doAuth()"></div>
      <button class="btn btn-primary btn-full" id="authBtn" onclick="doAuth()">Sign In</button>
      <div class="auth-hint" id="authHint">New here? Click Sign Up.</div>
    </div>`;
  document.getElementById('uploadGate').style.display='block';
  document.getElementById('uploadContent').style.display='none';
}

let authMode='in';
function switchTab(m){
  authMode=m;
  document.getElementById('tabIn').classList.toggle('active',m==='in');
  document.getElementById('tabUp').classList.toggle('active',m==='up');
  document.getElementById('authBtn').textContent=m==='in'?'Sign In':'Create Account';
  document.getElementById('aNameWrap').style.display=m==='up'?'block':'none';
  document.getElementById('authHint').textContent=m==='in'?'New here? Click Sign Up.':'A confirmation email will be sent.';
}

async function doAuth(){
  const email=document.getElementById('aEmail').value.trim();
  const pass=document.getElementById('aPass').value;
  if(!email){toast('Enter your email','err');return;}
  if(pass.length<6){toast('Password must be at least 6 characters','err');return;}
  const btn=document.getElementById('authBtn');
  btn.disabled=true;btn.textContent='‚Ä¶';
  if(authMode==='in'){
    const{error}=await sb.auth.signInWithPassword({email,password:pass});
    if(error){toast(error.message,'err');btn.disabled=false;btn.textContent='Sign In';}
    else toast('Welcome back! üéµ','ok');
  }else{
    const name=document.getElementById('aName')?.value.trim();
    const{error}=await sb.auth.signUp({email,password:pass,options:{data:{username:name||email.split('@')[0]}}});
    if(error){toast(error.message,'err');btn.disabled=false;btn.textContent='Create Account';}
    else{toast('Account created! Check your email to confirm.','info');btn.disabled=false;btn.textContent='Create Account';}
  }
}

function renderUserCard(){
  const u=S.user;
  const letter=(u.email||'U')[0].toUpperCase();
  const name=u.user_metadata?.username||u.email?.split('@')[0]||'User';
  document.getElementById('sidebarBottom').innerHTML=`
    <div class="user-card">
      <div class="avatar">${letter}</div>
      <div style="min-width:0"><div class="user-name">${x(name)}</div><div class="user-email">${x(u.email||'')}</div></div>
    </div>
    <button class="btn btn-ghost btn-full btn-sm" onclick="doSignOut()">Sign Out</button>`;
  document.getElementById('uploadGate').style.display='none';
  document.getElementById('uploadContent').style.display='block';
}

async function doSignOut(){
  await sb.auth.signOut();
  toast('Signed out','ok');
}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
function goTo(pg){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('p-'+pg)?.classList.add('active');
  document.querySelector(`.nav-btn[onclick="goTo('${pg}')"]`)?.classList.add('active');
  if(pg==='liked')renderLiked();
  if(pg==='history')loadHistory();
  if(pg==='playlists'){document.getElementById('plDetail').style.display='none';document.getElementById('plGrid').style.display='grid';loadPlaylists();}
  if(pg==='profile')loadProfile();
}

// ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');}));

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function fmt(s){if(!s||isNaN(s))return'0:00';return`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;}
function x(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,type='info'){
  const el=document.createElement('div');el.className=`toast ${type}`;
  el.innerHTML=`<span>${type==='ok'?'‚úì':type==='err'?'‚úó':'‚Ä¢'}</span> ${x(msg)}`;
  document.getElementById('toasts').appendChild(el);
  setTimeout(()=>el.remove(),4000);
}
</script>
</body>
</html>
